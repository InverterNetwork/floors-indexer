# Core Types & Conventions
# Note: Amount type removed - Envio requires entities to have id fields
# Monetary values are stored as {field}Raw: BigInt! and {field}Formatted: String!

type Token {
  id: ID!
  name: String!
  symbol: String!
  decimals: Int!
  maxSupplyRaw: BigInt!
  maxSupplyFormatted: String!
}

enum MarketStatus {
  ACTIVE
  PAUSED
  CLOSED
}

enum TradeType {
  BUY
  SELL
}

enum LoanStatus {
  ACTIVE
  REPAID
  DEFAULTED
}

enum StakeStatus {
  ACTIVE
  UNSTAKED
  LOCKED
}

enum CandlePeriod {
  ONE_HOUR
  FOUR_HOURS
  ONE_DAY
}

enum PresaleClaimType {
  DIRECT
  TRANCHE
}

enum PresaleConfigEventType {
  CAPS_UPDATED
  BASE_COMMISSION_UPDATED
  PRICE_BREAKPOINTS_SET
  PRESALE_STATE_SET
  END_TIMESTAMP_SET
  TIME_SAFEGUARD_SET
  WHITELIST_UPDATED
  LENDING_FACILITY_SET
  MODULE_INITIALIZED
  GENERIC
}

# User Group
# ------------------------------------------------------------

type Account {
  id: ID!
  marketsCreated: [Market!]! @derivedFrom(field: "creator_id")
  trades: [Trade!]! @derivedFrom(field: "user_id")
  loans: [Loan!]! @derivedFrom(field: "borrower_id")
  stakes: [Stake!]! @derivedFrom(field: "user_id")
  presaleParticipations: [PresaleParticipation!]! @derivedFrom(field: "user_id")
  userMarketPositions: [UserMarketPosition!]! @derivedFrom(field: "user_id")
}

type UserMarketPosition {
  id: ID!

  user_id: ID!
  market_id: ID!

  netFTokenChangeRaw: BigInt!
  netFTokenChangeFormatted: String!

  totalDebtRaw: BigInt!
  totalDebtFormatted: String!

  lockedCollateralRaw: BigInt!
  lockedCollateralFormatted: String!

  stakedAmountRaw: BigInt!
  stakedAmountFormatted: String!

  claimableRewardsRaw: BigInt!
  claimableRewardsFormatted: String!

  presaleDepositRaw: BigInt!
  presaleDepositFormatted: String!

  presaleLeverage: BigInt!

  lastUpdatedAt: BigInt!
}

# Contracts
# ------------------------------------------------------------

type ModuleRegistry {
  id: ID!

  floor: String!
  authorizer: String!
  feeTreasury: String!
  creditFacility: String
  presale: String
  staking: String

  createdAt: BigInt!
  lastUpdatedAt: BigInt!
}

type ModuleAddress {
  id: ID!
  market_id: ID!
  moduleType: String!
  createdAt: BigInt!
  lastUpdatedAt: BigInt!
}

type CreditFacilityContract {
  id: ID!

  market_id: ID!
  collateralToken_id: ID!
  borrowToken_id: ID!

  totalLoans: BigInt!

  totalVolumeRaw: BigInt!
  totalVolumeFormatted: String!

  totalDebtRaw: BigInt!
  totalDebtFormatted: String!

  totalLockedCollateralRaw: BigInt!
  totalLockedCollateralFormatted: String!

  lastUpdatedAt: BigInt!

  createdAt: BigInt!
  loans: [Loan!]! @derivedFrom(field: "facility_id")
}

type StakingContract {
  id: ID!

  stakingToken_id: ID!
  rewardToken_id: ID!

  totalStakedRaw: BigInt!
  totalStakedFormatted: String!

  totalRewardsRaw: BigInt!
  totalRewardsFormatted: String!

  createdAt: BigInt!
  stakes: [Stake!]! @derivedFrom(field: "contract_id")
}

type PreSaleContract {
  id: ID!

  saleToken_id: ID!
  purchaseToken_id: ID!

  market_id: ID
  startTime: BigInt!
  endTime: BigInt!
  timeSafeguardTs: BigInt

  maxLeverage: BigInt!
  currentState: Int!
  totalParticipants: BigInt!
  totalRaisedRaw: BigInt!
  totalRaisedFormatted: String!
  globalDepositCapRaw: BigInt!
  globalDepositCapFormatted: String!
  perAddressDepositCapRaw: BigInt!
  perAddressDepositCapFormatted: String!
  whitelistSize: BigInt!
  commissionBpsJson: String
  priceBreakpointsJson: String
  lendingFacility: String

  createdAt: BigInt!
  lastUpdatedAt: BigInt!
  participations: [PresaleParticipation!]! @derivedFrom(field: "presale_id")
  claims: [PresaleClaim!]! @derivedFrom(field: "presale_id")
  configEvents: [PresaleConfigEvent!]! @derivedFrom(field: "presale_id")
}

# Market
# ------------------------------------------------------------

type Market {
  id: ID!

  creator_id: ID!
  factory_id: ID!

  reserveToken: Token!
  issuanceToken: Token!

  initialFloorPriceRaw: BigInt!
  initialFloorPriceFormatted: String!

  tradingFeeBps: BigInt!
  buyFeeBps: BigInt!
  sellFeeBps: BigInt!

  maxLTV: BigInt!

  currentPriceRaw: BigInt!
  currentPriceFormatted: String!

  floorPriceRaw: BigInt!
  floorPriceFormatted: String!

  totalSupplyRaw: BigInt!
  totalSupplyFormatted: String!

  marketSupplyRaw: BigInt!
  marketSupplyFormatted: String!

  floorSupplyRaw: BigInt!
  floorSupplyFormatted: String!

  status: MarketStatus!
  isBuyOpen: Boolean!
  isSellOpen: Boolean!

  lastTradeTimestamp: BigInt!
  lastElevationTimestamp: BigInt!
  lastUpdatedAt: BigInt!

  trades: [Trade!]! @derivedFrom(field: "market_id")
  floorElevations: [FloorElevation!]! @derivedFrom(field: "market_id")
  feeDistributions: [FeeDistribution!]! @derivedFrom(field: "market_id")

  createdAt: BigInt!
}

type Trade {
  id: ID!

  market_id: ID!
  user_id: ID!

  tradeType: TradeType!

  tokenAmountRaw: BigInt!
  tokenAmountFormatted: String!

  reserveAmountRaw: BigInt!
  reserveAmountFormatted: String!

  feeRaw: BigInt!
  feeFormatted: String!

  newPriceRaw: BigInt!
  newPriceFormatted: String!

  timestamp: BigInt!
  transactionHash: String!
}

type FloorElevation {
  id: ID!
  market_id: ID!

  oldFloorPriceRaw: BigInt!
  oldFloorPriceFormatted: String!

  newFloorPriceRaw: BigInt!
  newFloorPriceFormatted: String!

  deployedAmountRaw: BigInt!
  deployedAmountFormatted: String!

  timestamp: BigInt!
  transactionHash: String!
}

type FeeDistribution {
  id: ID!
  market_id: ID!

  floorAmountRaw: BigInt!
  floorAmountFormatted: String!

  stakingAmountRaw: BigInt!
  stakingAmountFormatted: String!

  treasuryAmountRaw: BigInt!
  treasuryAmountFormatted: String!

  timestamp: BigInt!
  transactionHash: String!
}

type Loan {
  id: ID!

  borrower_id: ID!
  facility_id: ID!
  market_id: ID!

  lockedCollateralRaw: BigInt!
  lockedCollateralFormatted: String!

  borrowAmountRaw: BigInt!
  borrowAmountFormatted: String!

  originationFeeRaw: BigInt!
  originationFeeFormatted: String!

  remainingDebtRaw: BigInt!
  remainingDebtFormatted: String!

  floorPriceAtBorrowRaw: BigInt!
  floorPriceAtBorrowFormatted: String!

  status: LoanStatus!

  openedAt: BigInt!
  closedAt: BigInt
  lastUpdatedAt: BigInt!

  transactionHash: String!

  statusHistory: [LoanStatusHistory!]! @derivedFrom(field: "loan_id")
}

type LoanStatusHistory {
  id: ID!
  loan_id: ID!
  status: LoanStatus!
  remainingDebtRaw: BigInt!
  remainingDebtFormatted: String!
  lockedCollateralRaw: BigInt!
  lockedCollateralFormatted: String!
  timestamp: BigInt!
  transactionHash: String!
}

type Stake {
  id: ID!

  user_id: ID!
  contract_id: ID!

  amountRaw: BigInt!
  amountFormatted: String!

  lockDuration: BigInt!
  status: StakeStatus!

  timestamp: BigInt!
  transactionHash: String!
}

type PresaleParticipation {
  id: ID!
  user_id: ID!
  presale_id: ID!
  positionId: BigInt
  depositAmountRaw: BigInt!
  depositAmountFormatted: String!
  mintedAmountRaw: BigInt
  mintedAmountFormatted: String
  loopCount: BigInt
  leverage: BigInt!
  timestamp: BigInt!
  transactionHash: String!
}

type PresaleClaim {
  id: ID!
  presale_id: ID!
  positionId: BigInt
  claimType: PresaleClaimType!
  amountRaw: BigInt!
  amountFormatted: String!
  trancheIndex: BigInt
  loanId: BigInt
  timestamp: BigInt!
  transactionHash: String!
}

type PresaleConfigEvent {
  id: ID!
  presale_id: ID!
  eventType: PresaleConfigEventType!
  payloadJson: String!
  timestamp: BigInt!
  transactionHash: String!
}

# Historical Data
# ------------------------------------------------------------

type MarketSnapshot {
  id: ID!
  market_id: ID!
  timestamp: BigInt!
  priceRaw: BigInt!
  priceFormatted: String!
  floorPriceRaw: BigInt!
  floorPriceFormatted: String!
  totalSupplyRaw: BigInt!
  totalSupplyFormatted: String!
  marketSupplyRaw: BigInt!
  marketSupplyFormatted: String!
  volume24hRaw: BigInt!
  volume24hFormatted: String!
  trades24h: BigInt!
}

type PriceCandle {
  id: ID!
  market_id: ID!
  period: CandlePeriod!
  timestamp: BigInt!
  openRaw: BigInt!
  openFormatted: String!
  highRaw: BigInt!
  highFormatted: String!
  lowRaw: BigInt!
  lowFormatted: String!
  closeRaw: BigInt!
  closeFormatted: String!
  volumeRaw: BigInt!
  volumeFormatted: String!
  trades: BigInt!
}

type MarketRollingStats {
  id: ID!
  market_id: ID!
  windowSeconds: Int!
  volumeRaw: BigInt!
  volumeFormatted: String!
  averagePriceRaw: BigInt!
  averagePriceFormatted: String!
  tradeCount: BigInt!
  lastUpdatedAt: BigInt!
}

type GlobalStats {
  id: ID!
  totalMarkets: BigInt!
  activeMarkets: BigInt!
  totalVolumeRaw: BigInt!
  totalVolumeFormatted: String!
  totalOutstandingDebtRaw: BigInt!
  totalOutstandingDebtFormatted: String!
  totalLockedCollateralRaw: BigInt!
  totalLockedCollateralFormatted: String!
  lastUpdatedAt: BigInt!
}
